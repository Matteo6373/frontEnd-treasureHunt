<div class="card h-100 shadow border-0 rounded-4 overflow-hidden hover-scale"
     [style.backgroundImage]="'url(' + (treasure.theme | themeImage) + ')'"
     style="background-size: cover; background-position: center; transition: transform 0.3s;"
     id="card-{{ treasure.id }}">

  <!-- Overlay semi-trasparente -->
  <div class="card-overlay d-flex flex-column justify-content-between h-100 p-3 bg-dark bg-opacity-25">

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h5 class="card-title text-white mb-0">{{ treasure.theme }}</h5>
    </div>

    <!-- Body -->
    <div class="card-body p-0">
      <p class="card-text fst-italic text-white bg-dark bg-opacity-50 p-2 rounded">
        {{ treasure.hint }}
      </p>

      <!-- Pulsanti per generare o cancellare -->
      <div class="d-flex gap-2 mt-2 mb-3">
        @if (!loading()){
          <app-button-genererate-ai
            [treasure]="treasure"
            (generate)="generateCluesAI($event.treasure, $event.count)" >

          </app-button-genererate-ai>
        } @else {
          <div class="d-flex align-items-center gap-2 p-2 bg-light rounded shadow-sm">
            <div class="spinner-border text-primary" role="status" style="width:1.5rem; height:1.5rem;">
              <span class="visually-hidden">Caricamento...</span>
            </div>
            <span class="fw-semibold text-primary">Generazione in corso...</span>
          </div>
        }
        <button class="btn btn-sm btn-danger"
                (click)="deleteTreasure(treasure)">
          Cancella Caccia
        </button> </div>


      <ul
        cdkDropList
        [cdkDropListData]="treasure.clues"
        (cdkDropListDropped)="dropClue($event)"
        class="list-group rounded-4 overflow-hidden mt-3 clue-glass-ultra"
      >
        <li class="list-group-item bg-dark bg-opacity-50 border-0">
          <app-add-clue-component
            [treasure]="treasure"
            (add)="addClue($event)">
          </app-add-clue-component>
        </li>
        @for (clue of treasure.clues; track clue.id) {
          <li
            class="list-group-item p-0 bg-transparent border-0"
            cdkDrag
            cdkDragBoundary="#card-{{ treasure.id }}"
          >
            <div
              class="clue-flip-container"
              [class.flipped]="clue.showSolution"
              (click)="clue.showSolution = !clue.showSolution"
            >

              <!-- FRONTE (INDIZIO) -->
              <div class="clue-face clue-front">
                <div class="clue-glass">
                  <div class="clue-actions">
                    <button class="clue-btn edit" (click)="editClue(clue); $event.stopPropagation()">‚úèÔ∏è</button>
                    <button class="clue-btn delete" (click)="deleteClue(clue); $event.stopPropagation()">üóëÔ∏è</button>
                  </div>
                  <span class="clue-label">Indizio</span>
                  @if(!clue.editingText){
                    <p>{{ clue.text }}</p>
                  } @else {
                    <textarea
                      id="clue-textarea-{{clue.id}}"
                      class="clue-editor"
                      [(ngModel)]="clue.text"
                      (click)="$event.stopPropagation()"
                      (blur)="saveClue(clue); clue.editingText = false;"
                      (keydown.enter)="saveClue(clue); $event.preventDefault(); clue.editingText = false;"
                    ></textarea>
                  }
                </div>
              </div>

              <!-- RETRO (SOLUZIONE) -->
              <div class="clue-face clue-back">
                <div class="solution-glass">
                  <div class="clue-actions">
                    <button class="clue-btn edit" (click)="editClue(clue); $event.stopPropagation()">‚úèÔ∏è</button>
                    <button class="clue-btn delete" (click)="deleteClue(clue); $event.stopPropagation()">üóëÔ∏è</button>
                  </div>
                  <span class="clue-label text-warning">Soluzione</span>
                  @if (!clue.editingSolution){
                    <p>{{ clue.solution }}</p>
                  } @else {
                    <textarea
                      id="clue-solution-{{clue.id}}"
                      class="clue-editor"
                      [(ngModel)]="clue.solution"
                      (click)="$event.stopPropagation()"
                      (blur)="saveClue(clue); clue.editingSolution = false;"
                      (keydown.enter)="saveClue(clue); $event.preventDefault(); clue.editingSolution = false; "
                    ></textarea>
                  }
                </div>
              </div>

            </div>
          </li>

        }
        @empty {
          <li class="list-group-item text-muted fst-italic text-center">
            Nessun indizio disponibile
          </li>
        }
      </ul>
    </div>

  </div>
</div>
